*MySQL 服务器的性能受限于整个系统最薄弱的环节*

*当我们选择 MySQL 的硬件时，我们需要在性能和成本之间找到一个良好的平衡，而不是一味的追求强大的硬件。*

*数据库通常分为：OLTP 在线事务处理系统，OLAP 数据仓库，我们讨论的 MySQL 服务器属于 OLTP*


### 什么限制了 MySQL 性能?

1. CPU：当 MySQL 尝试`并行`执行太多的查询，或者当少量的查询在 CPU 上运行太长时间，就可能发生 CPU 饱和。
2. 内存：内存耗尽，通常只在你试图将`太多`的内存分配给 MySQL 时才会发生。
3. 硬盘：在使用 SSD 的情况下，磁盘耗尽比 CPU 耗尽的概率低的多。过去由于内存价格昂贵，数据库必须频繁的到 HDD 硬盘中获取数据，性能开销非常大。
4. 网络：通常情况下，网络不会成为瓶颈。

### CPU

*检查 CPU 使用率来确定工作负载是否受到 CPU 的限制，但不要只看总负载，而是要看`最重要查询`的 CPU 使用率和 I/O 之间的平衡*

- 一般来说，服务器需要达到`低延迟`和`高吞吐量`的要求，需要消耗更多的 CPU 资源。
- 如果工作负载没有用完所有的 CPU 资源，MySQL 服务器就可以使用剩下的资源执行后台任务，比如清理 InnoDB 缓冲区、执行网络操作等。
- 这些工作相比于执行查询而言，是次要的

### 内存

*配置大内存的原因是避免磁盘 I/O，重要的是平衡内存和磁盘空间的大小、速度、成本和其他因素*

- 如果内存足够，可以完全避开磁盘读取操作。如果所有数据都能装进内存，当服务器缓存预热完成，每次读取都将是缓存命中。
- 写入和读取一样可以在内存中执行，但迟早会写入磁盘，缓存可以延迟写操作，但不能消除。
- 缓存写入带来的好处有：
  - `多次写操作，一次刷新`：一个数据片段可以在内存中多次更改，无须每一次都将新值写入磁盘。当数据最终被刷新到磁盘时，自上次物理写入以来发生的所有修改都将被持久化。
  - `I/O 合并`：许多不同的数据片段可以在内存中被修改，这些修改可以被收集在一起，因此物理写入可以作为单个磁盘操作执行。

1. 在将内存作为缓存的时候，意味着内存系统的性能会直接影响查询的速度。
2. 时至今日，确保更快内存访问的最佳方法之一，仍然是用外部内存分配器（如 tcmalloc 或者 jemalloc ）替换内置的内存分配器（ glibc ）。

###  硬盘

*磁盘的选择取决于你的工作集*

- 你可以把数据库想象成带有存档抽屉的桌子，工作集就是桌面上需要处理的文件。
- 在这个类比中，抽屉就是硬盘，桌面则是内存。
- 就像你不需要把每张纸都放在桌面上一样，也不需要将整个数据库都塞进内存来获取最佳性能，仅仅将工作集放入内存即可。

1. 在使用 HDD 时，最好尝试找到一个有效的`内存/磁盘`比率，因为 HDD 的性能低，要避免其频繁读写。
2. 在使用 SSD 时，内存就变得没那么重要了。

#### SSD的优势

1. 比硬盘驱动器明显更好的随机读写性能。
2. 比硬盘驱动器更好的顺序读写性能。
3. 比硬盘驱动器更好的并发支持。

*最重要的是同时提升了随机 I/O 和高并发性。SSD 在高并发下能提供非常好的随机 I/O 性能。*

### 网络配置

*延迟和带宽是网络的限制因素*

- 对于大多数程序来说，最大的问题是延迟。一个典型的应用会进行很多次小的网络传输，每次传输都会有轻微的延迟。
- 网络运行不正常也是主要的性能瓶颈之一。因为网络协议的丢失重传等待，即使是1%的丢包也会导致显著的性能下降。

```bash
# 1.在配置中禁用 DNS 解析
skip_name_resolve

# 2.调整 linux 端口使用范围
echo 1024 65535 > /proc/sys/net/ipv4/ip_local_port_range

# 3.调整 linux TCP 队列大小
echo 4096 > /proc/sys/net/ipv4/tcp_max_syn_backlog

# 4.调整 linux TCP 服务器中断后关闭套接字时间
echo 5 >  /proc/sys/net/ipv4/tcp_fin_timeout
```

### 文件系统

*文件系统的选择很大程度上取决于操作系统*

- EXT4

*ext4优化*

```bash
vi /etc/fstab
/dev/sdb1 /usr/local/mysql  ext4  noatime,nodiratime,data=writeback 0 1
```

- XFS

*通常建议选择 xfs 文件系统*

#### 磁盘队列调度器

*不要使用 cfq，其他两种差异不大，centos7 默认是 deadline*

```bash
cat /sys/block/sda/queue/scheduler
noop [deadline] cfq
```

### 交换内存

*即使在 SSD 硬盘上，是用交换内存也是应该避免的情况。为了避免交换内存带来的影响，可以考虑关闭交换内存。*

```bash
# 1.如果启用了交换内存，可以使用降低其优先级的方式，减少交换内存的使用
echo 0 > /proc/sys/vm/swappiness
```
